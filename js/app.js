!function(e,t){"use strict";t.module("schedulizer",["ngResource","schedulizer.app","mgcrea.ngStrap.datepicker","mgcrea.ngStrap.timepicker","mgcrea.ngStrap.tooltip","calendry","ui.select","ngSanitize"]).config(["$provide","$locationProvider","$httpProvider",function(t,n,a){n.html5Mode(!1);var i=e.__schedulizer;t.factory("Routes",function(){var e={api:{calendar:i.api+"/calendar",calendarList:i.api+"/calendar_list",collection:i.api+"/collection",collectionEvent:i.api+"/collection_event",event:i.api+"/event",eventList:i.api+"/event_list",eventNullify:i.api+"/event_time_nullify",eventTags:i.api+"/event_tags",eventCategories:i.api+"/event_categories",timezones:i.api+"/timezones"},dashboard:i.dashboard,ajax:i.ajax};return{routeList:e,generate:function(t,n){var a=t.split(".").reduce(function(e,t){return e[t]},e);return(n||[]).length?a+"/"+n.join("/"):a}}}),a.interceptors.push(["$q","Alerter","ModalManager",function(e,t,n){return{responseError:function(a){var i="An error occurred; your request was not completed.";return a.data&&(a.data.error&&(i=a.data.error),"validationError"!==a.data.type&&(n.classes.open=!1)),t.add({msg:i,danger:!0}),e.reject(a)}}}])}]).factory("API",["$resource","Routes",function(e,n){function a(){return{update:{method:"PUT",params:{_method:"PUT"}}}}return{calendar:e(n.generate("api.calendar",[":id"]),{id:"@id"},t.extend(a(),{})),calendarList:e(n.generate("api.calendarList"),{},{get:{isArray:!0,cache:!0}}),collection:e(n.generate("api.collection",[":id",":subAction"]),{id:"@id"},{}),collectionEvent:e(n.generate("api.collectionEvent",[":subAction"]),{},t.extend(a(),{versionList:{method:"get",isArray:!0,cache:!1,params:{subAction:"version_list"}},approvedVersion:{method:"get",cache:!1,params:{subAction:"approved_version"}},approveLatestVersions:{method:"post",params:{subAction:"approve_latest_versions"}},unapprove:{method:"delete"},saveMultiAutoApprovable:{method:"put",params:{_method:"PUT",subAction:"multi_auto_approve"}},saveSingleAutoApprovable:{method:"put",params:{_method:"PUT"},transformRequest:function(e){return t.toJson({eventID:e.eventID,versionID:e.versionID,collectionID:e.collectionID,autoApprovable:e.autoApprovable})}}})),event:e(n.generate("api.event",[":id",":subAction"]),{id:"@id"},t.extend(a(),{image_path:{method:"get",cache:!1,params:{subAction:"image_path"}},updateActiveStatus:{method:"put",params:{_method:"PUT",subAction:"update_active_status"},transformRequest:function(e){return t.toJson({isActive:e.isActive})}}})),eventNullify:e(n.generate("api.eventNullify",[":eventTimeID",":id"]),{eventTimeID:"@eventTimeID",id:"@id"},t.extend(a(),{})),eventTags:e(n.generate("api.eventTags",[":id"]),{id:"@id"},t.extend(a(),{})),eventCategories:e(n.generate("api.eventCategories",[":id"]),{id:"@id"},t.extend(a(),{})),timezones:e(n.generate("api.timezones"),{},{get:{isArray:!0,cache:!0},defaultTimezone:{method:"GET",cache:!0,params:{config_default:!0}}}),_routes:n}}]),t.element(document).ready(function(){return e.__schedulizer?(t.bootstrap(document,["schedulizer"]),void 0):(alert("Schedulizer is missing a configuration to run and has aborted."),void 0)})}(window,window.angular),angular.module("schedulizer.app",[]),angular.module("calendry",[]),angular.module("schedulizer.app").run([function(){angular.element(document.body).append('<div alerter ng-class="{open:alerts.length}"><div class="alert-item" ng-repeat="alert in alerts" ng-class="{\'type-danger\':alert.danger,\'type-success\':alert.success}">{{ alert.msg }}<span alert-closer ng-click="removeAlert($index)">&#10005;</span></div></div>')}]).factory("Alerter",["$q","$timeout",function(e,t){var n={stack:[]};return n.add=function(e){n.stack.push(e),t(function(){n.stack.splice(n.stack.indexOf(e),1)},e.duration||3e3)},n.removeByIndex=function(e){n.stack.splice(e,1)},n}]).directive("alerter",[function(){function e(){}return{link:e,scope:!0,controller:["$scope","Alerter",function(e,t){e.service=t,e.alerts=[],e.removeAlert=e.service.removeByIndex,e.$watch("service",function(){e.alerts=e.service.stack},!0)}]}}]),angular.module("schedulizer.app").directive("eventTimeForm",[function(){function e(){}return{restrict:"A",templateUrl:"/event_timing_form",scope:{_timeEntity:"=eventTimeForm"},link:e,controller:["$rootScope","$scope","$filter","API","Helpers","ModalManager","_moment",function(e,t,n,a,i,r,o){function l(){null===t._timeEntity.repeatEvery&&(t._timeEntity.repeatEvery=t.repeatEveryOptions[0]),null===t._timeEntity.repeatIndefinite&&(t._timeEntity.repeatIndefinite=t.repeatIndefiniteOptions[0].value),t._timeEntity.repeatTypeHandle===t.repeatTypeHandleOptions[2].value&&(null===t._timeEntity.repeatMonthlyMethod&&(t._timeEntity.repeatMonthlyMethod=t.repeatMonthlyMethodOptions.specific),null===t._timeEntity.repeatMonthlySpecificDay&&(t._timeEntity.repeatMonthlySpecificDay=t.repeatMonthlySpecificDayOptions[0]),null===t._timeEntity.repeatMonthlyOrdinalWeek&&(t._timeEntity.repeatMonthlyOrdinalWeek=t.repeatMonthlyDynamicWeekOptions[0].value),null===t._timeEntity.repeatMonthlyOrdinalWeekday&&(t._timeEntity.repeatMonthlyOrdinalWeekday=t.repeatMonthlyDynamicWeekdayOptions[0].value))}function c(){t._timeEntity.repeatMonthlyMethod=null,t._timeEntity.repeatMonthlyOrdinalWeek=null,t._timeEntity.repeatMonthlyOrdinalWeekday=null,t._timeEntity.repeatMonthlySpecificDay=null}function s(){t._timeEntity.weeklyDays=[],angular.forEach(t.weekdayRepeatOptions,function(e){e.checked=!1})}function u(){c(),s(),t._timeEntity.repeatEndUTC=null,t._timeEntity.repeatEvery=null,t._timeEntity.repeatIndefinite=null,t._timeEntity.repeatTypeHandle=null}t.repeatTypeHandleOptions=i.repeatTypeHandleOptions(),t.repeatIndefiniteOptions=i.repeatIndefiniteOptions(),t.weekdayRepeatOptions=i.weekdayRepeatOptions(),t.repeatMonthlyMethodOptions=i.repeatMonthlyMethodOptions(),t.repeatMonthlySpecificDayOptions=i.range(1,31),t.repeatMonthlyDynamicWeekdayOptions=i.repeatMonthlyDynamicWeekdayOptions(),t.repeatMonthlyDynamicWeekOptions=i.repeatMonthlyDynamicWeekOptions(),t.selectedWeekdays=function(){var e=n("filter")(t.weekdayRepeatOptions,{checked:!0});t._timeEntity.weeklyDays=e.map(function(e){return e.value})},angular.isArray(t._timeEntity.weeklyDays)&&t._timeEntity.weeklyDays.length>=1&&angular.forEach(t.weekdayRepeatOptions,function(e){e.checked=t._timeEntity.weeklyDays.indexOf(e.value)>-1}),t.$watch("_timeEntity.repeatTypeHandle",function(e){switch(e){case t.repeatTypeHandleOptions[0].value:t.repeatEveryOptions=i.range(1,31),c(),s();break;case t.repeatTypeHandleOptions[1].value:t.repeatEveryOptions=i.range(1,30),c();break;case t.repeatTypeHandleOptions[2].value:t.repeatEveryOptions=i.range(1,11),s();break;case t.repeatTypeHandleOptions[3].value:t.repeatEveryOptions=i.range(1,5),c(),s()}null!==t._timeEntity.repeatTypeHandle&&l()}),t.$watch("_timeEntity.repeatIndefinite",function(e){e===!0&&(t._timeEntity.repeatEndUTC=null)}),t.$watch("_timeEntity.startUTC",function(e){e&&(t.calendarEndMinDate=o(e).subtract(1,"day"),o(t._timeEntity.endUTC).isBefore(o(t._timeEntity.startUTC))&&(t._timeEntity.endUTC=o(t._timeEntity.startUTC)))}),t.$watch("_timeEntity.isRepeating",function(e){e===!0&&null===t._timeEntity.repeatTypeHandle&&(t._timeEntity.repeatTypeHandle=t.repeatTypeHandleOptions[0].value),e===!1&&u()}),t.showNullifiers=!1,a.eventNullify.query({eventTimeID:t._timeEntity.id},function(e){t.hasNullifiers=e.length>=1,angular.forEach(e,function(e){e._moment=o.utc(e.hideOnDate)}),t.configuredNullifiers=e}),t.cancelNullifier=function(t){t.$delete(function(){e.$emit("calendar.refresh"),r.classes.open=!1})}}]}}]),angular.module("schedulizer.app").run([function(){angular.element(document.querySelector("body")).append('<div modal-window class="schedulizer-app" ng-class="manager.classes"><a class="icon-close default-closer" modal-close></a><div class="modal-inner" ng-include="manager.data.source"></div></div>')}]).factory("ModalManager",[function(){return{classes:{open:!1},data:{source:null}}}]).directive("modalize",[function(){function e(e,t,n){t.on("click",function(){e.$apply(function(){e.manager.data=angular.extend({source:n.modalize},e.using)})})}return{restrict:"A",scope:{using:"=using"},link:e,controller:["$scope","ModalManager",function(e,t){e.manager=t}]}}]).directive("modalClose",["ModalManager",function(e){function t(t,n){n.on("click",function(){t.$apply(function(){e.classes.open=!1,e.data=null})})}return{restrict:"A",link:t}}]).directive("modalWindow",[function(){function e(e){e.$watch("manager.classes.open",function(t){angular.element(document.documentElement).toggleClass("schedulizer-modal",t),t||(e.manager.data=null)})}return{restrict:"A",scope:!0,link:e,controller:["$scope","ModalManager",function(e,t){e.manager=t,e.$on("$includeContentLoaded",function(){e.manager.classes.open=!0})}]}}]),angular.module("schedulizer.app").directive("redactorized",["$q",function(){function e(e,n,a,i){var r=!1;i.$render=function(){return r?(angular.isDefined(i.$viewValue)&&n.redactor("code.set",i.$viewValue),void 0):(n.redactor(angular.extend(t,{initCallback:function(){r=!0,angular.isDefined(i.$viewValue)&&this.code.set(i.$viewValue)},changeCallback:function(){i.$setViewValue(this.code.get())}})),void 0)}}var t={minHeight:200,concrete5:{filemanager:!0,sitemap:!0},plugins:["concrete5lightbox","undoredo","specialcharacters","table","concrete5magic"]};return{priority:0,require:"?ngModel",restrict:"A",link:e}}]),angular.module("schedulizer.app").controller("CtrlCalendarForm",["$scope","$q","$window","ModalManager","API",function(e,t,n,a,i){e._ready=!1,e._requesting=!1;var r=[i.timezones.get().$promise,i.timezones.defaultTimezone().$promise];a.data.calendarID&&r.push(i.calendar.get({id:a.data.calendarID}).$promise),t.all(r).then(function(t){var a=document.querySelector("[data-calendar-owner-picker]"),r=null;a&&(r=+(a.getAttribute("data-default-owner-id")||1)),e.timezoneOptions=t[0],e.entity=t[2]||new i.calendar({defaultTimezone:e.timezoneOptions[e.timezoneOptions.indexOf(t[1].name)],ownerID:r}),e._ready=!0,a&&jQuery(a).dialog().on("click",function(){var t=jQuery(this);n.ConcreteEvent.unsubscribe("UserSearchDialogSelectUser.core"),n.ConcreteEvent.unsubscribe("UserSearchDialogAfterSelectUser.core"),n.ConcreteEvent.subscribe("UserSearchDialogSelectUser.core",function(n,a){t.text(a.uName),e.$apply(function(){e.entity.ownerID=a.uID})}),n.ConcreteEvent.subscribe("UserSearchDialogAfterSelectUser.core",function(){jQuery.fn.dialog.closeTop()})})},function(e){console.log(e)}),e.submitHandler=function(){e._requesting=!0,(e.entity.id?e.entity.$update():e.entity.$save()).then(function(t){e._requesting=!1,n.location.href=i._routes.generate("dashboard",["calendars","manage",t.id])},function(){e._requesting=!1})},e.confirmDelete=!1,e.deleteCalendar=function(){e.entity.$delete().then(function(e){e.ok&&(n.location.href=i._routes.generate("dashboard",["calendars"]))})}}]),angular.module("schedulizer.app").controller("CtrlCalendarPage",["$rootScope","$scope","$http","$cacheFactory","API","Alerter",function(e,t,n,a,i,r){function o(){return{includeinactives:!0,keywords:t.searchFields.keywords,tags:t.searchFields.tags.map(function(e){return e.id}).join(","),categories:t.searchFields.categories.map(function(e){return e.id}).join(",")}}function l(e){return n.get(i._routes.generate("api.eventList",[t.calendarID]),{cache:s,params:angular.extend({start:e.calendarStart.format("YYYY-MM-DD"),end:e.calendarEnd.format("YYYY-MM-DD"),fields:u.join(",")},o())})}function c(e){t.updateInProgress=!0,e===!0&&s.removeAll(),l(t.instance.monthMap).success(function(e){t.instance.events=e,t.updateInProgress=!1}).error(function(e,n){t.updateInProgress=!1,console.warn(n,"Failed fetching calendar data.")}),t.searchOpen=!1}t.updateInProgress=!1,t.searchOpen=!1,t.eventTagList=[],t.eventCategoryList=[],t.searchFiltersSet=!1,t.searchFields={keywords:null,tags:[],categories:[]},t.toggleSearch=function(){t.searchOpen=!t.searchOpen},i.eventTags.query().$promise.then(function(e){t.eventTagList=e}),i.eventCategories.query().$promise.then(function(e){t.eventCategoryList=e});var s=a("calendarData"),u=["eventID","eventTimeID","calendarID","title","isActive","eventColor","isAllDay","isSynthetic","computedStartUTC","computedStartLocal"];t.$watch("searchFields",function(e){var n=!1;e.keywords&&(n=!0),0!==e.tags.length&&(n=!0),0!==e.categories.length&&(n=!0),t.searchFiltersSet=n},!0),t.clearSearchFields=function(){t.searchFields={keywords:null,tags:[],categories:[]},c()},t.sendSearch=function(){c()},t.instance={parseDateField:"computedStartLocal",onMonthChange:function(){c()},onDropEnd:function(e,t){console.log(e,t)}},e.$on("calendar.refresh",function(){c(!0)}),t.permissionModal=function(e){jQuery.fn.dialog.open({title:"Calendar Permissions",href:e+"&bustCache="+Math.random().toString(36).substring(20)+Math.round(1e11*Math.random()).toString(),modal:!1,width:500,height:380})},t.warnNoPermission=function(){r.add({duration:1500,msg:"You do not have permission to edit.",danger:!0})}}]),angular.module("schedulizer.app").controller("CtrlCollectionEventForm",["$rootScope","$scope","$q","ModalManager","API",function(e,t,n,a,i){t.versionThumbnail=null;var r=[i.collectionEvent.versionList({eventID:a.data.eventID}).$promise,i.collectionEvent.approvedVersion({eventID:a.data.eventID,collectionID:a.data.collectionID}).$promise];n.all(r).then(function(e){t.versionList=e[0],t.approvedVersion=e[1]||null,angular.isObject(t.approvedVersion)&&t.versionList.forEach(function(e){+e.versionID===+t.approvedVersion.approvedVersionID&&t.viewVersion(e)})}),t.viewVersion=function(e){t.viewingVersion=e},t.$watch("viewingVersion",function(e){e&&i.event.image_path({id:+e.eventID},function(e){t.versionThumbnail=angular.isObject(e)?e.url:null})}),t.approveVersion=function(n){new i.collectionEvent({collectionID:+a.data.collectionID,eventID:+a.data.eventID,approvedVersionID:+n.versionID}).$save().then(function(n){t.approvedVersion=n,e.$emit("collection:refreshEventList"),a.classes.open=!1})}}]),angular.module("schedulizer.app").controller("CtrlCollectionForm",["$window","$rootScope","$scope","API","ModalManager","Alerter",function(e,t,n,a,i,r){n._ready=!0,n._requesting=!1,n.selectedCals={},n.checkToggleAll=!1,a.calendarList.get().$promise.then(function(e){n.calendarList=e,i.data.collectionID?a.collection.get({id:i.data.collectionID},function(e){n.entity=e,n.entity.collectionCalendars.forEach(function(e){n.selectedCals[e]=!0})}):n.entity=new a.collection({collectionCalendars:[]})}),n.toggleAllCheckboxes=function(){for(var e in n.selectedCals)n.selectedCals[e]=n.checkToggleAll},n.submitHandler=function(){n._requesting=!0,n.entity.collectionCalendars=Object.keys(n.selectedCals).filter(function(e){return n.selectedCals[e]}).map(function(e){return+e}),(n.entity.id?n.entity.$update():n.entity.$save()).then(function(t){n._requesting=!1,e.location.href=a._routes.generate("dashboard",["calendars","collections","manage",t.id])})},n.deleteCollection=function(){n.entity.$delete(function(){r.add({msg:"Collection Removed!",success:!0}),e.location.href=a._routes.generate("dashboard",["calendars","collections"])})}}]),angular.module("schedulizer.app").controller("CtrlCollectionPage",["$rootScope","$scope","$q","$http","API","_moment",function(e,t,n,a,i,r){function o(){var e=[];for(var n in t.checkboxes)t.checkboxes[n]===!0&&e.push(n);return e}t.collectionID=null,t.checkToggleAll=!1,t.checkboxes={},t.eventList=[],t.searchStart=r(),t.searchEnd=r().add(1,"month"),t.filters={grouping:!0,includeinactives:!0,calendars:null,discrepancies:null,fields:"eventID,versionID,title,calendarTitle,isActive"},t.toggleDiscrepanciesFilter=function(){t.filters.discrepancies=t.filters.discrepancies===!0?null:!0,t.refreshEventList()},t.$watchCollection("checkboxes",function(){var e=o();t.boxesAreChecked=e.length>=1}),t.toggleAllCheckboxes=function(){for(var e in t.checkboxes)t.checkboxes[e]=t.checkToggleAll},t.refreshEventList=function(){a.get(i._routes.generate("api.eventList"),{cache:!1,params:angular.extend({start:r(t.searchStart).format("YYYY-MM-DD"),end:r(t.searchEnd).format("YYYY-MM-DD"),dashboard_collection_search:t.collectionID},t.filters)}).then(function(e){t.checkboxes={},t.eventList=e.data,t.checkToggleAll=!1})},t.approveLatest=function(){i.collectionEvent.approveLatestVersions({collectionID:t.collectionID,events:o()},function(){t.refreshEventList()})},t.unapprove=function(){i.collectionEvent.unapprove({collectionID:t.collectionID,events:o().join(",")},function(){t.refreshEventList()})};var l=t.$watch("collectionID",function(e){e&&(l(),n.all([i.collection.get({id:e}).$promise,i.calendarList.get().$promise]).then(function(e){t.collectionObj=e[0];var n=e[1].filter(function(e){return-1!==t.collectionObj.collectionCalendars.indexOf(e.id)});n.unshift({id:null,title:"Filter By Calendar"}),t.calendarList=n,t.refreshEventList()}))});e.$on("collection:refreshEventList",t.refreshEventList),t.approvalList=[{value:!1,label:"Required"},{value:!0,label:"Auto"}],t.updateEventApproval=function(e){i.collectionEvent.saveSingleAutoApprovable(e,function(){e.approvedVersionID=e.versionID})},t.makeAutoApprovable=function(){i.collectionEvent.saveMultiAutoApprovable({collectionID:+t.collectionID,events:o()},t.refreshEventList)}}]),angular.module("schedulizer.app").controller("CtrlCollectionSearchPage",["$rootScope","$scope","API",function(){}]),angular.module("schedulizer.app").controller("CtrlEventForm",["$window","$rootScope","$scope","$q","$filter","$http","Helpers","ModalManager","Alerter","API","_moment","$compile",function(e,t,n,a,i,r,o,l,c,s,u,d){function p(e){return angular.extend({startUTC:u(),endUTC:u(),isOpenEnded:!1,isAllDay:!1,isRepeating:!1,repeatTypeHandle:null,repeatEvery:null,repeatIndefinite:null,repeatEndUTC:null,repeatMonthlyMethod:null,repeatMonthlySpecificDay:null,repeatMonthlyOrdinalWeek:null,repeatMonthlyOrdinalWeekday:null,weeklyDays:[]},e||{})}function f(t){var a={inputName:"fileID",filters:[{field:"type",type:1}]};return+t>=1==!1||angular.isDefined(t)===!1?(jQuery('[data-file-selector="fileID"]').concreteFileSelector(a),void 0):(jQuery.ajax({type:"post",dataType:"json",url:e.CCM_DISPATCHER_FILENAME+"/ccm/system/file/get_json",data:{fID:n.entity.fileID},error:function(){jQuery('[data-file-selector="fileID"]').concreteFileSelector(a)},success:function(){jQuery('[data-file-selector="fileID"]').concreteFileSelector(angular.extend(a,{fID:t}))}}),void 0)}n.activeMasterTab={1:!0},n.setMasterTabActive=function(e){n.activeMasterTab={},n.activeMasterTab[e]=!0},n._ready=!1,n._requesting=!1,n.eventColorOptions=o.eventColorOptions(),n.timingTabs=[],n.eventTagList=[],n.eventCategoryList=[],n.isActiveOptions=o.isActiveOptions(),n.warnAliased=l.data.eventObj.isSynthetic||!1,n.warnAliased&&(n._ready=!0);var v=[s.timezones.get().$promise,s.calendar.get({id:l.data.eventObj.calendarID}).$promise,s.eventTags.query().$promise,s.eventCategories.query().$promise];a.all(v).then(function(e){n.timezoneOptions=e[0],n.calendarObj=e[1],n.eventTagList=e[2],n.eventCategoryList=e[3],l.data.eventObj.eventID||(n.entity=new s.event({calendarID:n.calendarObj.id,title:"",description:"",useCalendarTimezone:!0,timezoneName:n.calendarObj.defaultTimezone,eventColor:n.eventColorOptions[0].value,isActive:n.isActiveOptions[0].value,_timeEntities:[p()]}),f(),n._ready=!0)}),l.data.eventObj.eventID&&(v.push(s.event.get({id:l.data.eventObj.eventID}).$promise),a.all(v).then(function(e){e[4]._timeEntities.map(function(e){return p(e)}),n.entity=e[4],f(n.entity.fileID),n._ready=!0})),n.attributeForm=s._routes.generate("ajax",["event_attributes_form",l.data.eventObj.eventID,"?bustCache="+Math.random().toString(36).substring(7)+Math.floor(1e4*Math.random())+1]),n.decorateAttributes=function(){var e=document.querySelector("[custom-attributes]"),t=e.querySelectorAll("input,select,textarea");n.entity._attributes={},Array.prototype.slice.call(t).forEach(function(e,t){var a=angular.element(e);return"checkbox"===a.get(0).type?(n.entity._attributes[t]=a.attr("checked")?1:null,a.attr("ng-model","entity._attributes["+t+"]"),a.attr("ng-true-value",1),a.attr("ng-false-value",null),d(a)(n),void 0):(n.entity._attributes[t]=a.val(),a.attr("ng-model","entity._attributes["+t+"]"),d(a)(n),void 0)})},n.tagTransform=function(e){return{displayText:e}},n.setTimingTabActive=function(e){angular.forEach(n.timingTabs,function(e){e.active=!1}),n.timingTabs[e].active=!0},n.addTimeEntity=function(){n.entity._timeEntities.push(p())},n.removeTimeEntity=function(e){n.entity._timeEntities.splice(e,1)},n.$watchCollection("entity._timeEntities",function(e){angular.isArray(e)&&(n.timingTabs=o.range(1,e.length).map(function(t,n){return{label:"Time "+t,active:n===e.length-1}}))}),n.$watch("entity.isActive",function(e,a){"boolean"==typeof e&&"boolean"==typeof a&&n.entity.id&&(n.frmEventData.$setPristine(),n._requesting=!0,n.entity.$updateActiveStatus(function(){t.$emit("calendar.refresh"),l.classes.open=!1}))}),n.$watch("calendarObj",function(e){angular.isObject(e)&&(n.useCalendarTimezoneOptions=[{label:"Use Calendar Timezone ("+n.calendarObj.defaultTimezone+")",value:!0},{label:"Event Uses Custom Timezone",value:!1}])}),n.$watch("entity.useCalendarTimezone",function(e){e===!0&&(n.entity.timezoneName=n.calendarObj.defaultTimezone)}),n.submitHandler=function(){n._requesting=!0;var e=a(function(e){n.entity.fileID=parseInt(jQuery('input[type="hidden"]',".ccm-file-selector").val())||null,(n.entity.id?n.entity.$update():n.entity.$save()).then(function(t){e(t)},function(){n._requesting=!1})});e.then(function(e){var a=s._routes.generate("api.event",["attributes",e.id]),i=jQuery("input,select,textarea","[custom-attributes]").serialize();jQuery.post(a,i).done(function(){n.$apply(function(){n._requesting=!1,t.$emit("calendar.refresh"),l.classes.open=!1})}).fail(function(e){c.add({msg:e.responseJSON.error,danger:!0})})})},n.confirmDelete=!1,n.deleteEvent=function(){n.entity.$delete().then(function(){t.$emit("calendar.refresh"),l.classes.open=!1})},n.nullifyInSeries=function(){var e=new s.eventNullify({eventTimeID:l.data.eventObj.eventTimeID,hideOnDate:l.data.eventObj.computedStartUTC});e.$save().then(function(){t.$emit("calendar.refresh"),l.classes.open=!1})}}]),angular.module("schedulizer.app").controller("CtrlSearchPage",["$rootScope","$scope","$http","$cacheFactory","API","_moment",function(e,t,n,a,i,r){function o(e){return e.id}function l(){return angular.extend({calendars:t.searchFields.calendar,start:r(t.searchStart).format("YYYY-MM-DD"),end:r(t.searchEnd).format("YYYY-MM-DD"),fields:d.join(","),keywords:t.searchFields.keywords,tags:t.searchFields.tags.map(o).join(","),categories:t.searchFields.categories.map(o).join(",")},t.showAllEvents?{includeinactives:!0}:{},t.doGrouping?{grouping:!0}:{})}function c(){return n.get(i._routes.generate("api.eventList"),{cache:u,params:l()})}function s(){t.updateInProgress=!0,u.removeAll(),c().success(function(e){t.resultData=e,t.updateInProgress=!1}).error(function(e,n){t.updateInProgress=!1,console.warn(n,"Failed fetching data")}),t.searchOpen=!1}var u=a("searchCalendarData"),d=["eventID","eventTimeID","calendarID","calendarTitle","title","eventColor","isAllDay","isSynthetic","computedStartUTC","computedStartLocal","isActive"];t.momentJS=r,t.resultData=[],t.updateInProgress=!1,t.searchOpen=!1,t.eventTagList=[],t.eventCategoryList=[],t.searchFiltersSet=!1,t.isActiveOptions=[{label:"Include Inactive",value:!0},{label:"Active Only",value:!1}],t.showAllEvents=!0,t.groupingOptions=[{label:"Group Events",value:!0},{label:"Show Repeating",value:!1}],t.doGrouping=!0,t.searchStart=r(),t.searchEnd=r().add(1,"month"),t.searchFields={keywords:null,tags:[],categories:[],calendar:null},t.toggleSearch=function(){t.searchOpen=!t.searchOpen},i.eventTags.query().$promise.then(function(e){t.eventTagList=e}),i.eventCategories.query().$promise.then(function(e){t.eventCategoryList=e}),i.calendarList.get().$promise.then(function(e){e.unshift({id:null,title:"Filter By Calendar"}),t.calendarList=e}),t.$watch("searchFields",function(e){var n=!1;e.keywords&&(n=!0),0!==e.tags.length&&(n=!0),0!==e.categories.length&&(n=!0),+e.calendar>=1&&(n=!0),t.searchFiltersSet=n},!0),t.clearSearchFields=function(){t.searchFields={keywords:null,tags:[],categories:[]},s()},t.sendSearch=s,e.$on("calendar.refresh",s),s()}]),angular.module("schedulizer.app").controller("CtrlSettingsPage",["$scope","API",function(e,t){e.activeTab=0,e.activateTab=function(t){e.activeTab=t},e.categoriesList=[],e.tagsList=[],t.eventCategories.query().$promise.then(function(t){e.categoriesList=t}),t.eventTags.query().$promise.then(function(t){e.tagsList=t}),e.remove=function(e,t){e[t].$delete().then(function(){e.splice(t,1)})},e.persist=function(e,t){e[t].id?e[t].$update():e[t].$save()},e.addCategory=function(){e.categoriesList.push(new t.eventCategories)},e.addTag=function(){e.tagsList.push(new t.eventTags)}}]),angular.module("schedulizer.app").filter("numberContraction",function(){var e=["th","st","nd","rd"];return function(t){var n=20>t?t:t%(10*Math.floor(t/10)),a=3>=n?e[n]:e[0];return a}}),angular.module("schedulizer.app").filter("propsFilter",function(){return function(e,t){var n=[];return angular.isArray(e)?e.forEach(function(e){for(var a=!1,i=Object.keys(t),r=0;r<i.length;r++){var o=i[r],l=t[o].toLowerCase();if(-1!==e[o].toString().toLowerCase().indexOf(l)){a=!0;break}}a&&n.push(e)}):n=e,n}}),angular.module("schedulizer.app").provider("_moment",function(){this.$get=["$window","$log",function(e,t){return e.moment||(t.warn("MomentJS unavailable!"),!1)}]}),angular.module("schedulizer.app").factory("Helpers",["_moment",function(){return this.range=function(e,t){for(var n=[],a=e;t>=a;a++)n.push(a);return n},this.isActiveOptions=function(){return[{label:"Active",value:!0},{label:"Inactive",value:!1}]},this.repeatTypeHandleOptions=function(){return[{label:"Days",value:"daily"},{label:"Weeks",value:"weekly"},{label:"Months",value:"monthly"},{label:"Years",value:"yearly"}]},this.repeatIndefiniteOptions=function(){return[{label:"Forever",value:!0},{label:"Until",value:!1}]},this.weekdayRepeatOptions=function(){return[{label:"Sun",value:1},{label:"Mon",value:2},{label:"Tue",value:3},{label:"Wed",value:4},{label:"Thu",value:5},{label:"Fri",value:6},{label:"Sat",value:7}]},this.repeatMonthlyMethodOptions=function(){return{specific:"specific",dynamic:"ordinal"}},this.repeatMonthlyDynamicWeekOptions=function(){return[{label:"First",value:1},{label:"Second",value:2},{label:"Third",value:3},{label:"Fourth",value:4},{label:"Last",value:5}]},this.repeatMonthlyDynamicWeekdayOptions=function(){return[{label:"Sunday",value:1},{label:"Monday",value:2},{label:"Tuesday",value:3},{label:"Wednesday",value:4},{label:"Thursday",value:5},{label:"Friday",value:6},{label:"Saturday",value:7}]},this.eventColorOptions=function(){return[{value:"#A3D900"},{value:"#3A87AD"},{value:"#DE4E56"},{value:"#BFBFFF"},{value:"#FFFF73"},{value:"#FFA64D"},{value:"#CCCCCC"},{value:"#00B7FF"},{value:"#222222"}]},this}]),function(e,t){"use strict";t.module("calendry").factory("MomentJS",["$window","$log",function(e,t){return e.moment||(t.warn("Moment.JS not available in global scope, Calendry will be unavailable."),!1)}]).directive("calendry",["$cacheFactory","$document","$log","$q","MomentJS",function(e,n,a,i,r){function o(e){this.monthStart=e,this.monthEnd=r(this.monthStart).endOf("month"),this.calendarStart=r(this.monthStart).subtract(this.monthStart.day(),"day"),this.calendarEnd=r(this.monthEnd).add(6-this.monthEnd.day(),"day"),this.calendarDayCount=Math.abs(this.calendarEnd.diff(this.calendarStart,"days")),this.calendarDays=function(e,t,n){for(var a=0;e>=a;a++)n.push(r(t).add("days",a));return n}(this.calendarDayCount,this.calendarStart,[])}function l(e){var t=r.isMoment(e)?r(e).startOf("month"):r({day:1}),n=t.format(h);return f.get(n)?f.get(n):(f.put(n,new o(t)),f.get(n))}function c(e){return g.dayCellClass+"-"+e.format("YYYY_MM_DD")}function s(e){var t=r(),n=e.monthStart.format("YYYY_MM");if(v.get(n))return v.get(n).cloneNode(!0);for(var a=p.createDocumentFragment(),i=0,o=e.calendarDays.length;o>i;i++){var l=p.createElement("div"),s=e.calendarDays[i].isSame(e.monthStart,"month")?"month-incl":"month-excl",u=e.calendarDays[i].isSame(t,"day")?"is-today":"";l.setAttribute("id",c(e.calendarDays[i])),l.className=g.dayCellClass+" "+s+" "+u,l.innerHTML='<span class="date-num">'+e.calendarDays[i].format("DD")+"<small>"+e.calendarDays[i].format("MMM")+"</small></span>",a.appendChild(l)}return v.put(n,a),v.get(n).cloneNode(!0)}function u(e){var t=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;e=e.replace(t,function(e,t,n,a){return t+t+n+n+a+a});var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return n?{r:parseInt(n[1],16),g:parseInt(n[2],16),b:parseInt(n[3],16)}:null}function d(e,n,a,i,o){function l(){for(var e;e=p.pop();)e.remove();for(var t;t=f.pop();)t.$destroy()}function u(e){l();var a=t.element(n[0].querySelector(".calendar-render")),i=Math.ceil(e.calendarDayCount/7);t.element(n[0].querySelector(".calendry-body")).removeClass("week-rows-4 week-rows-5 week-rows-6").addClass("week-rows-"+i);var r=s(e);Array.prototype.slice.call(r.childNodes).forEach(function(n,a){r.childNodes[a]=t.element(n).data("_moment",e.calendarDays[a])}),a.empty().append(r)}function d(a){function i(e,t,n){e.append(t),p.push(t),f.push(n)}t.element(n[0].querySelectorAll(".event-cell")).remove();var l={};a.forEach(function(t){t._moment=r(t[e.instance.parseDateField],r.ISO_8601);var n=t._moment.format(m);l[n]||(l[n]=[]),l[t._moment.format(m)].push(t)}),e.instance.monthMap.calendarDays.forEach(function(a){var r=l[a.format(m)];if(r){var s=t.element(n[0].querySelector("#"+c(a)));if(s)for(var u=0,d=r.length;d>u;u++){var p=e.$new();p.eventObj=r[u],o(p,i.bind(null,s))}}})}var p=[],f=[];e.$watch("instance.monthMap",function(e){e&&u(e)}),e.$watch("events",function(e){t.isArray(e)&&d(e)})}if(!r)return a.warn("Calendry not instantiated due to missing momentJS library"),void 0;var p=n[0],f=e("monthMap"),v=e("docFrags"),h="YYYY_MM",m="YYYY_MM_DD",g={forceListView:!1,daysOfWeek:r.weekdaysShort(),currentMonth:r(),dayCellClass:"day-node",parseDateField:"startDate",onMonthChange:function(){},onDropEnd:function(){}};return{restrict:"A",scope:{instance:"=calendry"},replace:!0,templateUrl:"/calendry",transclude:!0,link:d,controller:["$scope",function(e){var n=this;e.instance=t.extend(n,g,e.instance||{}),this.goToCurrentMonth=e.goToCurrentMonth=function(){e.instance.currentMonth=r()},this.goToPrevMonth=e.goToPrevMonth=function(){e.instance.currentMonth=r(e.instance.currentMonth).subtract({months:1})},this.goToNextMonth=e.goToNextMonth=function(){e.instance.currentMonth=r(e.instance.currentMonth).add({months:1})},this.toggleListView=e.toggleListView=function(){e.instance.forceListView=!e.instance.forceListView},e.$watch("instance.currentMonth",function(t){t&&(e.instance.monthMap=l(t),e.instance.onMonthChange.apply(n,[e.instance.monthMap]))}),e.$watch("instance.events",function(t){t&&(e.events=t)}),e.helpers={eventFontColor:function(e){var t=u(e),n=Math.round((299*t.r+587*t.g+114*t.b)/1e3);return n>125?"#000000":"#FFFFFF"}}}]}}])}(window,window.angular);